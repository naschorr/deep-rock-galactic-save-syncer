@using Core.SaveFiles.Models
@using GUI.Data
@using Core.Enums
@using System.Reactive.Linq

<ImageHeaderBar imagePath="@GetImagePath()" imageClasses="icon-xl mr-3" containerClasses="mt-1 mb-3 ml-1 mr-1" text="@($"{GetSaveFileName()} Save File")" textClasses="h2" barHeight="32px" />
<div class="pl-1 pr-1 position-relative save-file-container @(ReferenceEquals(saveFile, Overwriter) ? "active" : "")"
    @onmouseover="@(e => highlight = true)"
    @onmouseout="@(e => highlight = false)">
    <div class="top-left @(highlight ? "highlight" : "") @(ReferenceEquals(saveFile, Overwriter) ? "active" : "")"></div>
    <div class="top-right @(highlight ? "highlight" : "") @(ReferenceEquals(saveFile, Overwriter) ? "active" : "")"></div>
    <div class="bottom-left @(highlight ? "highlight" : "") @(ReferenceEquals(saveFile, Overwriter) ? "active" : "")"></div>
    <div class="bottom-right @(highlight ? "highlight" : "") @(ReferenceEquals(saveFile, Overwriter) ? "active" : "")"></div>
    <div class="row pb-2">
        <div class="col">
            <Dwarf dwarf="@saveFile.Engineer" type="DwarfType.Engineer"/>
            <Dwarf dwarf="@saveFile.Scout" type="DwarfType.Scout"/>
            <Dwarf dwarf="@saveFile.Driller" type="DwarfType.Driller" />
            <Dwarf dwarf="@saveFile.Gunner" type="DwarfType.Gunner" />
        </div>
    </div>
    <div class="row pb-2">
        <div class="col">
            <SaveFileMetadata saveFile="@saveFile" />
        </div>
    </div>
</div>

@code {
    [Inject]
    public SyncerManagerService SyncerManager { get; set; } = default!;

    [Parameter]
    public Core.SaveFiles.Models.SaveFile? saveFile { get; set; }

    private bool highlight = false;
    private Core.SaveFiles.Models.SaveFile? Overwriter;

    protected override void OnInitialized()
    {
        Overwriter = SyncerManager.Overwriter;
        SyncerManager.OverwriterChanged.DistinctUntilChanged()
            .Select(saveFile => Overwriter = saveFile)
            .Subscribe();
    }

    private string GetSaveFileName()
    {
        if (typeof(SteamSaveFile).IsInstanceOfType(saveFile))
        {
            return "Steam";
        }
        else if (typeof(XboxSaveFile).IsInstanceOfType(saveFile))
        {
            return "Xbox";
        }

        return "Unknown";
    }

    private string GetImagePath()
    {
        var platform = GetSaveFileName();

        return $"images/platform_icons/{platform.ToLower()}_icon.png";
    }
}
